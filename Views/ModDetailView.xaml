<UserControl x:Class="GHPC_Mod_Manager.Views.ModDetailView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:GHPC_Mod_Manager.Converters"
             xmlns:resources="clr-namespace:GHPC_Mod_Manager.Resources"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="900">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InvBoolToVis"/>
        <converters:StringToVisibilityConverter x:Key="StrToVis"/>
    </UserControl.Resources>

    <Grid Background="{DynamicResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 顶部：返回按钮 + MOD名称 -->
        <Border Grid.Row="0" Background="{DynamicResource SurfaceVariantBrush}" Padding="12,8">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0"
                    Content="{x:Static resources:Strings.GoBack}"
                    Command="{Binding GoBackCommand}"
                    Style="{DynamicResource TextButtonStyle}"
                    Margin="0,0,16,0"/>

            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                <TextBlock Text="{Binding Mod.DisplayName}"
                           FontSize="{DynamicResource TitleMedium}"
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource OnSurfaceVariantBrush}"/>
                <TextBlock Text="{Binding Mod.Id}"
                           FontSize="{DynamicResource LabelSmall}"
                           Foreground="{DynamicResource OnSurfaceVariantBrush}"
                           Opacity="0.7"/>
            </StackPanel>
        </Grid>
        </Border>

        <!-- 详情内容区 -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="16">
            <StackPanel>

                <!-- Tags行 -->
                <StackPanel Visibility="{Binding Mod.Tags.Count, Converter={StaticResource BoolToVis}}"
                            Margin="0,0,0,16">
                    <TextBlock Text="{x:Static resources:Strings.ModTags}"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource OnSurfaceBrush}"
                               Margin="0,0,0,6"/>
                    <ItemsControl ItemsSource="{Binding Mod.LocalizedTags}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource PrimaryContainerBrush}"
                                        CornerRadius="10" Padding="10,4" Margin="3,2">
                                    <TextBlock Text="{Binding}"
                                               FontSize="{DynamicResource LabelSmall}"
                                               Foreground="{DynamicResource OnPrimaryContainerBrush}"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <!-- 简介 -->
                <StackPanel Visibility="{Binding Mod.LocalizedDescription, Converter={StaticResource StrToVis}}"
                            Margin="0,0,0,16">
                    <TextBlock Text="{x:Static resources:Strings.ModDescription}"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource OnSurfaceBrush}"
                               Margin="0,0,0,6"/>
                    <Border Background="{DynamicResource SurfaceVariantBrush}"
                            CornerRadius="{DynamicResource RadiusSmall}"
                            Padding="12,10">
                        <TextBlock Text="{Binding Mod.LocalizedDescription}"
                                   TextWrapping="Wrap"
                                   Foreground="{DynamicResource OnSurfaceVariantBrush}"
                                   LineHeight="22"/>
                    </Border>
                </StackPanel>

                <!-- 支持的游戏版本 -->
                <StackPanel Visibility="{Binding Mod.SupportedGameVersions.Count, Converter={StaticResource BoolToVis}}"
                            Margin="0,0,0,16">
                    <TextBlock Text="{x:Static resources:Strings.SupportedVersions}"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource OnSurfaceBrush}"
                               Margin="0,0,0,6"/>
                    <ItemsControl ItemsSource="{Binding Mod.SupportedGameVersions}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource SurfaceVariantBrush}"
                                        BorderBrush="{DynamicResource OutlineVariantBrush}"
                                        BorderThickness="1"
                                        CornerRadius="4" Padding="8,3" Margin="3,2">
                                    <TextBlock Text="{Binding}"
                                               FontSize="{DynamicResource LabelSmall}"
                                               Foreground="{DynamicResource OnSurfaceVariantBrush}"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <!-- 版本信息 + 安装/管理 -->
                <Border Background="{DynamicResource SurfaceVariantBrush}"
                        CornerRadius="{DynamicResource RadiusSmall}"
                        Padding="16,12" Margin="0,0,0,16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- 已安装版本 -->
                        <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal" Margin="0,0,0,8"
                                    Visibility="{Binding Mod.IsInstalled, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="{x:Static resources:Strings.InstalledVersion}"
                                       Foreground="{DynamicResource OnSurfaceVariantBrush}"
                                       Margin="0,0,8,0"/>
                            <TextBlock Text="{Binding Mod.InstalledVersion}"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource SuccessBrush}"/>
                        </StackPanel>

                        <!-- 版本选择下拉 -->
                        <StackPanel Grid.Row="1" Grid.Column="0" Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="{x:Static resources:Strings.SelectVersion}"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource OnSurfaceVariantBrush}"
                                       Margin="0,0,8,0"/>
                            <TextBlock Text="{x:Static resources:Strings.LoadingReleases}"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource OnSurfaceVariantBrush}"
                                       Opacity="0.7"
                                       Visibility="{Binding IsLoadingReleases, Converter={StaticResource BoolToVis}}"/>
                            <ComboBox ItemsSource="{Binding AvailableReleases}"
                                      SelectedItem="{Binding SelectedRelease}"
                                      DisplayMemberPath="TagName"
                                      MinWidth="140"
                                      Visibility="{Binding IsLoadingReleases, Converter={StaticResource InvBoolToVis}}"/>
                        </StackPanel>

                        <!-- 安装按钮（未安装时） -->
                        <StackPanel Grid.Row="2" Grid.Column="0" Orientation="Horizontal" Margin="0,0,0,0"
                                    Visibility="{Binding Mod.IsInstalled, Converter={StaticResource InvBoolToVis}}">
                            <!-- 有备份时显示快速重装 -->
                            <Button Content="{x:Static resources:Strings.QuickReinstall}"
                                    Command="{Binding InstallSelectedVersionCommand}"
                                    Style="{DynamicResource OutlinedButtonStyle}"
                                    MinWidth="120" Margin="0,0,8,0"
                                    Visibility="{Binding Mod.HasBackup, Converter={StaticResource BoolToVis}}"/>
                            <!-- 无备份时显示正常安装 -->
                            <Button Content="{x:Static resources:Strings.InstallSpecificVersion}"
                                    Command="{Binding InstallSelectedVersionCommand}"
                                    Style="{DynamicResource FilledButtonStyle}"
                                    MinWidth="120" Margin="0,0,8,0"
                                    Visibility="{Binding Mod.HasBackup, Converter={StaticResource InvBoolToVis}}"/>
                        </StackPanel>

                        <!-- 管理按钮（已安装时） -->
                        <WrapPanel Grid.Row="3" Grid.Column="0" Margin="0,4,0,0"
                                   Visibility="{Binding Mod.IsInstalled, Converter={StaticResource BoolToVis}}">

                            <!-- 更新（有可用更新时） -->
                            <Button Content="{x:Static resources:Strings.Update}"
                                    Command="{Binding UpdateCommand}"
                                    Style="{DynamicResource FilledButtonStyle}"
                                    MinWidth="80" Margin="0,0,8,4"
                                    Visibility="{Binding Mod.CanUpdate, Converter={StaticResource BoolToVis}}"/>

                            <!-- 安装选定版本（重装/降级） -->
                            <Button Content="{x:Static resources:Strings.InstallSpecificVersion}"
                                    Command="{Binding InstallSelectedVersionCommand}"
                                    Style="{DynamicResource OutlinedButtonStyle}"
                                    MinWidth="120" Margin="0,0,8,4"/>

                            <!-- 启用/禁用 -->
                            <Button Content="{x:Static resources:Strings.Toggle}"
                                    Command="{Binding ToggleCommand}"
                                    Style="{DynamicResource OutlinedButtonStyle}"
                                    MinWidth="80" Margin="0,0,8,4"/>

                            <!-- 配置（有配置项时） -->
                            <Button Content="{x:Static resources:Strings.Configure}"
                                    Command="{Binding ConfigureCommand}"
                                    Style="{DynamicResource OutlinedButtonStyle}"
                                    MinWidth="80" Margin="0,0,8,4"
                                    Visibility="{Binding Mod.HasConfiguration, Converter={StaticResource BoolToVis}}"/>

                            <!-- 卸载 -->
                            <Button Content="{x:Static resources:Strings.Uninstall}"
                                    Command="{Binding UninstallCommand}"
                                    Style="{DynamicResource OutlinedButtonStyle}"
                                    MinWidth="80" Margin="0,0,0,4"/>
                        </WrapPanel>

                        <!-- 状态消息 -->
                        <TextBlock Grid.Row="0" Grid.Column="1" Grid.RowSpan="4"
                                   Text="{Binding StatusMessage}"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource OnSurfaceVariantBrush}"
                                   FontSize="{DynamicResource LabelSmall}"
                                   TextWrapping="Wrap"
                                   MaxWidth="200"
                                   Margin="16,0,0,0"
                                   Visibility="{Binding StatusMessage, Converter={StaticResource StrToVis}}"/>
                    </Grid>
                </Border>

                <!-- 依赖列表 -->
                <StackPanel Visibility="{Binding HasDependencies, Converter={StaticResource BoolToVis}}"
                            Margin="0,0,0,16">
                    <TextBlock Text="{x:Static resources:Strings.DependenciesSection}"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource OnSurfaceBrush}"
                               Margin="0,0,0,8"/>
                    <ItemsControl ItemsSource="{Binding Dependencies}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource SurfaceVariantBrush}"
                                        CornerRadius="{DynamicResource RadiusSmall}"
                                        Padding="12,8" Margin="0,3">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- 依赖MOD名称（可点击跳转） -->
                                        <Button Grid.Column="0"
                                                Style="{DynamicResource TextButtonStyle}"
                                                Command="{Binding DataContext.NavigateToDependencyCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding ModId}"
                                                HorizontalAlignment="Left"
                                                Padding="0" MinWidth="0" BorderThickness="0" Background="Transparent">
                                            <TextBlock Text="{Binding DisplayName}"
                                                       Foreground="{DynamicResource PrimaryBrush}"
                                                       TextDecorations="Underline"/>
                                        </Button>

                                        <!-- 安装状态标签 -->
                                        <Border Grid.Column="1"
                                                Background="{DynamicResource SuccessBrush}"
                                                CornerRadius="4" Padding="6,2" Margin="8,0"
                                                Visibility="{Binding IsInstalled, Converter={StaticResource BoolToVis}}">
                                            <TextBlock Text="{x:Static resources:Strings.Installed}"
                                                       FontSize="{DynamicResource LabelSmall}"
                                                       Foreground="{DynamicResource OnSuccessBrush}"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"/>
                                        </Border>
                                        <Border Grid.Column="1"
                                                Background="{DynamicResource ErrorBrush}"
                                                CornerRadius="4" Padding="6,2" Margin="8,0"
                                                Visibility="{Binding IsInstalled, Converter={StaticResource InvBoolToVis}}">
                                            <TextBlock Text="{x:Static resources:Strings.DependencyMissing}"
                                                       FontSize="{DynamicResource LabelSmall}"
                                                       Foreground="{DynamicResource OnErrorBrush}"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"/>
                                        </Border>

                                        <!-- 点击安装提示（未安装时显示） -->
                                        <TextBlock Grid.Column="2"
                                                   Text="{x:Static resources:Strings.ClickToInstall}"
                                                   FontSize="{DynamicResource LabelSmall}"
                                                   Foreground="{DynamicResource OnSurfaceVariantBrush}"
                                                   Opacity="0.7"
                                                   VerticalAlignment="Center"
                                                   Visibility="{Binding IsInstalled, Converter={StaticResource InvBoolToVis}}"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <!-- 冲突列表 -->
                <StackPanel Visibility="{Binding HasConflicts, Converter={StaticResource BoolToVis}}"
                            Margin="0,0,0,16">
                    <TextBlock Text="{x:Static resources:Strings.ConflictsSection}"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource OnSurfaceBrush}"
                               Margin="0,0,0,8"/>
                    <ItemsControl ItemsSource="{Binding Conflicts}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource SurfaceVariantBrush}"
                                        CornerRadius="{DynamicResource RadiusSmall}"
                                        Padding="12,8" Margin="0,3">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <Button Grid.Column="0"
                                                Style="{DynamicResource TextButtonStyle}"
                                                Command="{Binding DataContext.NavigateToDependencyCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding ModId}"
                                                HorizontalAlignment="Left"
                                                Padding="0" MinWidth="0" BorderThickness="0" Background="Transparent">
                                            <TextBlock Text="{Binding DisplayName}"
                                                       Foreground="{DynamicResource PrimaryBrush}"
                                                       TextDecorations="Underline"/>
                                        </Button>

                                        <!-- 冲突MOD安装状态 -->
                                        <Border Grid.Column="1"
                                                Background="{DynamicResource WarningBrush}"
                                                CornerRadius="4" Padding="6,2" Margin="8,0"
                                                Visibility="{Binding IsInstalled, Converter={StaticResource BoolToVis}}">
                                            <TextBlock Text="{x:Static resources:Strings.Installed}"
                                                       FontSize="{DynamicResource LabelSmall}"
                                                       Foreground="{DynamicResource OnWarningBrush}"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"/>
                                        </Border>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <!-- GitHub链接 -->
                <Button Content="{x:Static resources:Strings.ViewOnGitHub}"
                        Command="{Binding OpenGitHubCommand}"
                        Style="{DynamicResource OutlinedButtonStyle}"
                        HorizontalAlignment="Left"
                        Margin="0,0,0,16"
                        Visibility="{Binding Mod.GitHubRepositoryUrl, Converter={StaticResource StrToVis}}"/>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>

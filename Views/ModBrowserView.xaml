<UserControl x:Class="GHPC_Mod_Manager.Views.ModBrowserView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:GHPC_Mod_Manager.Converters"
             xmlns:resources="clr-namespace:GHPC_Mod_Manager.Resources"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="1200">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InvBoolToVis"/>
        <converters:InverseBooleanConverter x:Key="InvBool"/>
        <converters:StringToVisibilityConverter x:Key="StrToVis"/>
    </UserControl.Resources>

    <Grid Background="{DynamicResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 工具栏 -->
        <Grid Grid.Row="0" Margin="12,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="{x:Static resources:Strings.Search}"
                           VerticalAlignment="Center" Margin="0,0,8,0"
                           Foreground="{DynamicResource OnSurfaceBrush}"/>
                <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Width="220" Margin="0,0,12,0"
                         Style="{DynamicResource MaterialTextBoxStyle}"/>
                <TextBlock Text="{Binding FilteredModCount}"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource OnSurfaceVariantBrush}"
                           FontSize="{DynamicResource LabelMedium}"/>
            </StackPanel>

            <!-- 右侧按钮 -->
            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Content="{x:Static resources:Strings.ClearTagFilter}"
                        Command="{Binding ClearTagFilterCommand}"
                        Style="{DynamicResource TextButtonStyle}"
                        Margin="0,0,4,0"/>
                <Button Content="{x:Static resources:Strings.Refresh}"
                        Command="{Binding RefreshCommand}"
                        Style="{DynamicResource TextButtonStyle}"
                        Margin="0,0,4,0"/>
                <Button Content="{x:Static resources:Strings.CheckForUpdates}"
                        Command="{Binding CheckForUpdatesCommand}"
                        Style="{DynamicResource OutlinedButtonStyle}"/>
            </StackPanel>
        </Grid>

        <!-- Tag筛选栏 -->
        <Border Grid.Row="1"
                Background="{DynamicResource SurfaceVariantBrush}"
                Padding="8,6" Margin="0,0,0,4">
            <StackPanel>
                <TextBlock Text="{x:Static resources:Strings.FilterByTags}"
                           FontSize="{DynamicResource LabelSmall}"
                           Foreground="{DynamicResource OnSurfaceVariantBrush}"
                           Margin="4,0,0,4"/>
                <ScrollViewer HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding AvailableTags}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <ToggleButton Content="{Binding DisplayName}"
                                              IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                              Style="{DynamicResource ChipToggleButtonStyle}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </StackPanel>
        </Border>

        <!-- 无结果提示 -->
        <TextBlock Grid.Row="2"
                   Text="{x:Static resources:Strings.NoModsMatchFilter}"
                   HorizontalAlignment="Center" VerticalAlignment="Center"
                   Foreground="{DynamicResource OnSurfaceVariantBrush}"
                   FontSize="{DynamicResource BodyLarge}"
                   Visibility="{Binding FilteredMods.Count, Converter={StaticResource InvBoolToVis}}"/>

        <!-- MOD列表 -->
        <DataGrid Grid.Row="2"
                  ItemsSource="{Binding FilteredMods}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  IsReadOnly="True"
                  SelectionUnit="FullRow"
                  CanUserSortColumns="False"
                  CanUserResizeColumns="False">
            <DataGrid.CellStyle>
                <Style TargetType="DataGridCell" BasedOn="{StaticResource MaterialDataGridCellStyle}">
                    <Setter Property="Focusable" Value="False"/>
                    <Setter Property="IsTabStop" Value="False"/>
                </Style>
            </DataGrid.CellStyle>

            <DataGrid.Columns>

                <!-- 名称列（点击进入详情） -->
                <DataGridTemplateColumn Header="{x:Static resources:Strings.Name}" Width="*" MinWidth="100">
                    <DataGridTemplateColumn.HeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDataGridColumnHeaderStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGridTemplateColumn.HeaderStyle>
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Button Style="{DynamicResource TextButtonStyle}"
                                    Command="{Binding DataContext.NavigateToDetailCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                    CommandParameter="{Binding}"
                                    Padding="4,0" MinWidth="0" BorderThickness="0" Background="Transparent"
                                    HorizontalAlignment="Left"
                                    ToolTip="{Binding DisplayName}">
                                <TextBlock Text="{Binding DisplayName}"
                                           Foreground="{DynamicResource PrimaryBrush}"
                                           TextDecorations="Underline"
                                           TextTrimming="CharacterEllipsis"/>
                            </Button>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- 最新版本：内容过长时横向滚动 -->
                <DataGridTemplateColumn Header="{x:Static resources:Strings.LatestVersion}" Width="*" MinWidth="120">
                    <DataGridTemplateColumn.HeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDataGridColumnHeaderStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGridTemplateColumn.HeaderStyle>
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding LatestVersionWithDate}"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"
                                       TextTrimming="CharacterEllipsis"
                                       ToolTip="{Binding LatestVersionWithDate}"
                                       Margin="4,0"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Tags列：单行截断 + ToolTip完整内容 -->
                <DataGridTemplateColumn Header="{x:Static resources:Strings.ModTags}" Width="*" MinWidth="100">
                    <DataGridTemplateColumn.HeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDataGridColumnHeaderStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGridTemplateColumn.HeaderStyle>
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding LocalizedTagsText}"
                                       VerticalAlignment="Center"
                                       TextTrimming="CharacterEllipsis"
                                       ToolTip="{Binding LocalizedTagsText}"
                                       FontSize="{DynamicResource LabelSmall}"
                                       Foreground="{DynamicResource OnSurfaceVariantBrush}"
                                       Margin="4,0"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- 支持版本列：列头截断+ToolTip，内容横向滚动 -->
                <DataGridTemplateColumn Width="*" MinWidth="80">
                    <DataGridTemplateColumn.HeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDataGridColumnHeaderStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                            <Setter Property="ToolTip" Value="{x:Static resources:Strings.SupportedVersions}"/>
                        </Style>
                    </DataGridTemplateColumn.HeaderStyle>
                    <DataGridTemplateColumn.Header>
                        <TextBlock Text="{x:Static resources:Strings.SupportedVersions}"
                                   TextTrimming="CharacterEllipsis"
                                   ToolTip="{x:Static resources:Strings.SupportedVersions}"/>
                    </DataGridTemplateColumn.Header>
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding SupportedVersionsText}"
                                       VerticalAlignment="Center"
                                       TextTrimming="CharacterEllipsis"
                                       ToolTip="{Binding SupportedVersionsText}"
                                       FontSize="{DynamicResource LabelSmall}"
                                       Foreground="{DynamicResource OnSurfaceVariantBrush}"
                                       Margin="4,0"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- 操作列 -->
                <DataGridTemplateColumn Header="{x:Static resources:Strings.Actions}" Width="220" MinWidth="180">
                    <DataGridTemplateColumn.HeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDataGridColumnHeaderStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGridTemplateColumn.HeaderStyle>
                    <DataGridTemplateColumn.CellStyle>
                        <Style TargetType="DataGridCell" BasedOn="{StaticResource MaterialDataGridCellStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGridTemplateColumn.CellStyle>
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">

                                <!-- 未安装且有备份：快速重装 -->
                                <Button Content="{x:Static resources:Strings.QuickReinstall}"
                                        Command="{Binding DataContext.InstallModCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        MinWidth="80" Margin="2"
                                        Style="{DynamicResource OutlinedButtonStyle}"
                                        Visibility="{Binding CanQuickReinstall, Converter={StaticResource BoolToVis}}"/>

                                <!-- 未安装且无备份：安装最新版 -->
                                <Button Content="{x:Static resources:Strings.InstallLatestVersion}"
                                        Command="{Binding DataContext.InstallModCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        MinWidth="80" Margin="2"
                                        Style="{DynamicResource FilledButtonStyle}"
                                        Visibility="{Binding CanInstallFresh, Converter={StaticResource BoolToVis}}"/>

                                <!-- 已安装：更新/详情 -->
                                <StackPanel Orientation="Horizontal"
                                            Visibility="{Binding IsInstalled, Converter={StaticResource BoolToVis}}">
                                    <Button Content="{x:Static resources:Strings.Update}"
                                            Command="{Binding DataContext.InstallModCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            MinWidth="60" Margin="2"
                                            Style="{DynamicResource FilledButtonStyle}"
                                            Visibility="{Binding CanUpdate, Converter={StaticResource BoolToVis}}"/>
                                    <Button Content="{x:Static resources:Strings.ViewDetails}"
                                            Command="{Binding DataContext.NavigateToDetailCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            MinWidth="60" Margin="2"
                                            Style="{DynamicResource OutlinedButtonStyle}"/>
                                </StackPanel>

                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

            </DataGrid.Columns>
        </DataGrid>

    </Grid>
</UserControl>

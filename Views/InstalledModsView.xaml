<UserControl x:Class="GHPC_Mod_Manager.Views.InstalledModsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:GHPC_Mod_Manager.Converters"
             xmlns:resources="clr-namespace:GHPC_Mod_Manager.Resources"
             xmlns:models="clr-namespace:GHPC_Mod_Manager.Models"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="1200">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InvBoolToVis"/>
        <converters:InverseBooleanConverter x:Key="InvBool"/>
        <converters:StringToVisibilityConverter x:Key="StrToVis"/>
        <converters:StringToInverseVisibilityConverter x:Key="StrToInvVis"/>
        <converters:TranslationPluginVisibilityConverter x:Key="TransPluginVis"/>
        <converters:ModEnableStateConverter x:Key="ModEnableState"/>
    </UserControl.Resources>

    <Grid Background="{DynamicResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 工具栏 -->
        <Grid Grid.Row="0" Margin="12,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- 搜索框 -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="{x:Static resources:Strings.Search}"
                           VerticalAlignment="Center" Margin="0,0,8,0"
                           Foreground="{DynamicResource OnSurfaceBrush}"/>
                <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Width="220" Margin="0,0,12,0"
                         Style="{DynamicResource OutlinedTextBoxStyle}"/>
                <TextBlock Text="{Binding InstalledModCount}"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource OnSurfaceVariantBrush}"
                           FontSize="{DynamicResource LabelMedium}"/>
            </StackPanel>

            <!-- 右侧按钮 -->
            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Content="{x:Static resources:Strings.Refresh}"
                        Command="{Binding RefreshCommand}"
                        Style="{DynamicResource TextButtonStyle}"
                        Margin="0,0,4,0"/>
                <Button Content="{x:Static resources:Strings.CheckForUpdates}"
                        Command="{Binding CheckForUpdatesCommand}"
                        IsEnabled="{Binding IsCheckingUpdates, Converter={StaticResource InvBool}}"
                        Style="{DynamicResource OutlinedButtonStyle}"/>
            </StackPanel>
        </Grid>

        <!-- 空状态提示 -->
        <TextBlock Grid.Row="1"
                   Text="{x:Static resources:Strings.InstalledModsEmpty}"
                   HorizontalAlignment="Center" VerticalAlignment="Center"
                   Foreground="{DynamicResource OnSurfaceVariantBrush}"
                   FontSize="{DynamicResource BodyLarge}">
            <TextBlock.Visibility>
                <Binding Path="FilteredInstalledMods.Count">
                    <Binding.Converter>
                        <converters:InverseBooleanToVisibilityConverter/>
                    </Binding.Converter>
                </Binding>
            </TextBlock.Visibility>
        </TextBlock>

        <!-- MOD列表 -->
        <DataGrid Grid.Row="1"
                  ItemsSource="{Binding FilteredInstalledMods}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  IsReadOnly="True"
                  SelectionUnit="FullRow"
                  CanUserSortColumns="False"
                  CanUserResizeColumns="False"
                  Margin="0">
            <DataGrid.CellStyle>
                <Style TargetType="DataGridCell" BasedOn="{StaticResource MaterialDataGridCellStyle}">
                    <Setter Property="Focusable" Value="False"/>
                    <Setter Property="IsTabStop" Value="False"/>
                </Style>
            </DataGrid.CellStyle>

            <DataGrid.Columns>

                <!-- 名称列：含详情跳转按钮 + 依赖状态图标 -->
                <DataGridTemplateColumn Header="{x:Static resources:Strings.Name}" Width="*" MinWidth="120">
                    <DataGridTemplateColumn.HeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDataGridColumnHeaderStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGridTemplateColumn.HeaderStyle>
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="4,0">

                                <!-- 点击跳转详情的按钮 -->
                                <Button Style="{DynamicResource TextButtonStyle}"
                                        Command="{Binding DataContext.NavigateToDetailCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        Padding="0" MinWidth="0" BorderThickness="0" Background="Transparent">
                                    <TextBlock Text="{Binding DisplayName}"
                                               Foreground="{DynamicResource PrimaryBrush}"
                                               TextDecorations="Underline"
                                               TextWrapping="Wrap"/>
                                </Button>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- 已安装版本 -->
                <DataGridTextColumn Header="{x:Static resources:Strings.InstalledVersion}"
                                    Binding="{Binding InstalledVersion}"
                                    Width="*" MinWidth="100">
                    <DataGridTextColumn.HeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDataGridColumnHeaderStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGridTextColumn.HeaderStyle>
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Center"/>
                            <Setter Property="VerticalAlignment" Value="Center"/>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <!-- 最新版本 -->
                <DataGridTextColumn Header="{x:Static resources:Strings.LatestVersion}"
                                    Binding="{Binding LatestVersionWithDate}"
                                    Width="*" MinWidth="140">
                    <DataGridTextColumn.HeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDataGridColumnHeaderStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGridTextColumn.HeaderStyle>
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Center"/>
                            <Setter Property="VerticalAlignment" Value="Center"/>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <!-- 启用状态 -->
                <DataGridTemplateColumn Header="{x:Static resources:Strings.Enabled}" Width="*" MinWidth="90">
                    <DataGridTemplateColumn.HeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDataGridColumnHeaderStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGridTemplateColumn.HeaderStyle>
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <CheckBox HorizontalAlignment="Center" VerticalAlignment="Center"
                                      IsChecked="{Binding IsEnabled, Mode=OneWay}"
                                      IsEnabled="{Binding IsInstalled, Converter={StaticResource ModEnableState}}"
                                      Command="{Binding DataContext.ToggleModCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                      CommandParameter="{Binding}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- 操作列（已安装MOD专用：无安装按钮） -->
                <DataGridTemplateColumn Header="{x:Static resources:Strings.Actions}" Width="300" MinWidth="260">
                    <DataGridTemplateColumn.HeaderStyle>
                        <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDataGridColumnHeaderStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGridTemplateColumn.HeaderStyle>
                    <DataGridTemplateColumn.CellStyle>
                        <Style TargetType="DataGridCell" BasedOn="{StaticResource MaterialDataGridCellStyle}">
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        </Style>
                    </DataGridTemplateColumn.CellStyle>
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <!-- 更新按钮 -->
                                <Button Content="{x:Static resources:Strings.Update}"
                                        Command="{Binding DataContext.UpdateModCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        MinWidth="60" Margin="2"
                                        Style="{DynamicResource FilledButtonStyle}"
                                        Visibility="{Binding CanUpdate, Converter={StaticResource BoolToVis}}"/>
                                <!-- 卸载按钮 -->
                                <Button Content="{x:Static resources:Strings.Uninstall}"
                                        Command="{Binding DataContext.UninstallModCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        MinWidth="60" Margin="2"
                                        Style="{DynamicResource OutlinedButtonStyle}"
                                        IsEnabled="{Binding CanUninstall}"/>
                                <!-- 启用/禁用切换 -->
                                <Button Content="{x:Static resources:Strings.Toggle}"
                                        Command="{Binding DataContext.ToggleModCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        MinWidth="60" Margin="2"
                                        Style="{DynamicResource OutlinedButtonStyle}"/>
                                <!-- 配置按钮（仅有配置时显示） -->
                                <Button Content="{x:Static resources:Strings.Configure}"
                                        Command="{Binding DataContext.ConfigureModCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        MinWidth="60" Margin="2"
                                        Style="{DynamicResource TextButtonStyle}"
                                        Visibility="{Binding HasConfiguration, Converter={StaticResource BoolToVis}}"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

            </DataGrid.Columns>
        </DataGrid>

    </Grid>
</UserControl>
